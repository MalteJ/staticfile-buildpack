#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
set -x          # enable debugging

# Configure directories
build_dir=$1
cache_dir=$2

# Version
apache_version="2.4.10"

compile_buildpack_dir=$(cd $(dirname $0); cd ..; pwd)
compile_buildpack_bin=$compile_buildpack_dir/bin

# Load some convenience functions like status(), echo(), and indent()
source $compile_buildpack_dir/bin/common.sh

cd $cache_dir

wget http://mirror.arcor-online.net/www.apache.org//httpd/httpd-$apache_version.tar.gz
wget http://ftp.halifax.rwth-aachen.de/apache//apr/apr-1.5.1.tar.gz
wget http://ftp.halifax.rwth-aachen.de/apache//apr/apr-util-1.5.4.tar.gz

tar xzvf httpd-$apache_version.tar.gz
tar xzvf apr-1.5.1.tar.gz
tar xzvf apr-util-1.5.4.tar.gz

mkdir -p /app/apache2/libs

cd apr-1.5.1
./configure --prefix=/app/apache2/libs/apr
make
make install
cd ..

cd apr-util-1.5.4
./configure --prefix=/app/apache2/libs/apr-util --with-apr=/app/apache2/libs/apr --enable-static-support
make
make install
cd ..

cd httpd-$apache_version

./configure --prefix=$build --with-apr=/app/apache2/libs/apr --with-apr-util=/app/apache2/libs/apr-util --enable-static-support
make
make install
cd ..

rm -rf /app/apache2/man
rm -rf /app/apache2/icons
rm -rf /app/apache2/htdocs/*
rm -rf /app/apache2/logs/*
rm -rf /app/apache2/cgi-bin/*

cp -ra /app/apache2/* $build_dir/

cd $build_dir

# Alternate root location (default is root of project) for html/js/css
# root: dist/
if [[ "$(grep root: Staticfile)X" != "X" ]]; then
  root_dir=$(grep root: Staticfile | sed -e 's/^root: *//')
  status "Root folder $root_dir"
else
  status "Using root folder"
fi
root_dir=${root_dir:-.}

status "Copying project files into htdocs/"
mkdir -p $cache_dir/htdocs
mv $root_dir/* $cache_dir/htdocs
mv $cache_dir/htdocs .

# if using root dir, then Staticfile* files would be accessible by nginx
if [[ -f htdocs/Staticfile ]]; then
  echo "Moving Staticfile away from public access" | indent
  mv htdocs/Staticfile* .
fi

status "Setting up apache2"
tar xzf $compile_apache_tgz
cp -f $compile_buildpack_dir/conf/httpd.conf apache2/conf/httpd.conf

[[ -f $build_dir/htdocs/httpd.conf ]] && mv $build_dir/htdocs/httpd.conf apache2/conf/httpd.conf

cp $compile_buildpack_bin/boot.sh .
